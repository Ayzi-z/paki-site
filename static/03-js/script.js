/* ============================= */
/* FUNÃ‡Ã•ES DO SISTEMA DE LOGIN E CADASTRO DE USUARIOS*/
/* ============================= */

/*Sistema validador de dados durante o cadastro*/
document.addEventListener('DOMContentLoaded', () => {
    const formCadastro = document.getElementById("formCadastro");

    if (formCadastro) /* Verificando se o formulario de cadastro existe na pÃ¡gina*/ {
        const inputEmail = formCadastro.querySelector("#email");
        const inputTipo = formCadastro.querySelector('#tipo-usuario');

        inputTipo.addEventListener("change", () => {
            let tipoSelecionado = inputTipo.value
            let grupoTipo = inputTipo.closest(".grupo-formulario");
            
            const inputCodigo = document.querySelector("#grupo-codigo-ativacao");
            
            const inputEscala = document.querySelector('#grupo-dias-trabalho')
            
            if (inputCodigo) inputCodigo.remove();

            if (inputEscala) inputEscala.remove()

            if (tipoSelecionado === "nutricionista") {
                
                /* Criando um input pro codigo de ativacao */
                const divGrupo = document.createElement("div");
                divGrupo.classList.add("grupo-formulario");
                divGrupo.id = "grupo-codigo-ativacao"; 

                const labelCodigo = document.createElement("label");
                labelCodigo.setAttribute("for", "codigo_ativacao");
                labelCodigo.textContent = "NÃºmero do seu cÃ³digo de ativaÃ§Ã£o:";

    
                const inputCodigo = document.createElement("input");
                inputCodigo.type = "text";
                inputCodigo.name = "codigo_ativacao";
                inputCodigo.id = "codigo_ativacao";
                inputCodigo.required = true;
                inputCodigo.placeholder = "Digite o cÃ³digo de ativaÃ§Ã£o";

                /*Colocando a label e o input do codigo dentro da div*/
                divGrupo.appendChild(labelCodigo);
                divGrupo.appendChild(inputCodigo);

                /* Colocando a div logo depois do tipo de usuario*/
                grupoTipo.parentNode.insertBefore(divGrupo, grupoTipo.nextSibling);


                /* criando input para inserir a escala de dias do nutricionista*/
                const grupo_formulario = document.createElement("div");
                grupo_formulario.classList.add("grupo-formulario");
                grupo_formulario.id = "grupo-dias-trabalho";
        
                const label = document.createElement("label");
                label.textContent = "Selecione os dias que vocÃª trabalha na clinica:";
                grupo_formulario.appendChild(label);

                const diasSemana = ["segunda","terca","quarta","quinta","sexta"];
                const container_opcoes = document.createElement("div");
                diasSemana.forEach(dia => {
                    const label_dia = document.createElement("label");

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "dias_trabalho";
                    checkbox.value = dia;

                    label_dia.appendChild(checkbox);

                    const texto = document.createTextNode(dia.charAt(0).toUpperCase() + dia.slice(1));
                    
                    label_dia.appendChild(texto);

                    container_opcoes.appendChild(label_dia);
                });

        grupo_formulario.appendChild(label);
        grupo_formulario.appendChild(container_opcoes);
        grupoTipo.parentNode.insertBefore(grupo_formulario, grupoTipo.nextSibling);

            }
        });

        inputEmail.addEventListener("blur", () => { /*Verificando se o e-mail jÃ¡ existe sempre que sai do campo*/
            let email = inputEmail.value.trim();

            fetch('/validarcadastro', { /*Vendo se o email existe naquela api do banco de dados*/
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(dados => {

            console.log(dados)
            
            if (dados.email === true) /* Se o email existe faz isso no input e no formulario*/ {
                window.alert("O email Informado jÃ¡ existe no banco de dados")
                inputEmail.style.borderColor = "red";
                let aviso_email = document.getElementById("aviso-email") /*Vendo se jÃ¡ existe alguma mensagem de erro*/;
                    if (!aviso_email)/* se nao existir uma mensagem de erro no input ele cria uma*/{
                        aviso = document.createElement("p");
                        aviso.id = "aviso-email";
                        aviso.style.color = "red";
                        aviso.textContent = "Este e-mail jÃ¡ existe!";
                        inputEmail.parentNode.appendChild(aviso);
                        
                      
                    }
            } else /* Se o e-mail nao existir no banco ele tira os erros do input*/ {
                inputEmail.style.borderColor = "";
                const aviso = document.getElementById("aviso-email");
                if (aviso) aviso.remove();
            }
            });
        });
    }
});

/*Funcao para cadastrar usuario*/
document.addEventListener('DOMContentLoaded', () => {
    const formCadastro = document.getElementById('formCadastro');

    if (formCadastro) {
        formCadastro.addEventListener('submit', async (event) => {
            event.preventDefault(); 

            const dados = {
                nome: document.getElementById('nome').value,

                sobrenome: document.getElementById('sobrenome').value,
                
                email: document.getElementById('email').value,
                
                senha: document.getElementById('senha').value,
                
                tipo_usuario: document.getElementById('tipo-usuario').value,
                
                data_nascimento: document.getElementById('data_nascimento').value,
                
                telefone: document.getElementById('telefone').value,
                
                genero: document.getElementById('genero').value,
                
                idade: document.getElementById('idade').value,
                
                peso: document.getElementById('peso').value,
                
                altura: document.getElementById('altura').value,
                
                doenca_cronica: document.getElementById('doenca_cronica').value,
            };

            console.log(dados)
           
            if (dados.tipo_usuario === 'nutricionista') {
                const codigo = document.getElementById('codigo_ativacao');
                if (codigo) dados.codigo_ativacao = codigo.value;

                const checkboxes = document.querySelectorAll('#grupo-dias-trabalho input[type="checkbox"]:checked');
                dados.dias_trabalho = Array.from(checkboxes).map(cb => cb.value);
            }

            try {
                const resposta = await fetch('/cadastro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await resposta.json();

                if (resultado.sucesso) {
                    window.location.href = '/';
                } else {
                    mensagem_popup('Erro ao cadastrar o usuÃ¡rio!', 'erro')
                }
            } catch (error) {
               console.error('Erro ao cadastrar:', error);
               mensagem_popup('Erro ao cadastrar o usuÃ¡rio!', 'erro')
            }
        });
    }
});

/*Funcao para logar o usuario*/
document.addEventListener('DOMContentLoaded', () => {
    const formLogin = document.getElementById('formLogin');

    if (formLogin) {
        formLogin.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            const dados = {     
                email: document.getElementById('email').value,
                
                senha: document.getElementById('senha').value,
            };

            console.log(dados)

            try {
                const resposta = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await resposta.json();

                if (resultado.sucesso) {
                    window.location.href = '/';
                } else {
                    mensagem_popup(`${resultado.erro}`, 'erro')
                }
            } catch (error) {
               mensagem_popup('Erro ao logar o usuÃ¡rio!', 'erro')
            }
        });
    }
});


/* ============================= */
/* FUNÃ‡Ã•ES DE CONSULTA LADO PACIENTE*/
/* ============================= */

/*Esse Ã© o objeto que vai salvar as informacoes da nova consulta, e depois vai ser mandado pro Flask*/
let novaConsulta = {
    data_hora: {},
    motivo: "",
    id_nutricionista: "",
    id_paciente: ""
}

/*Sistema do slider das perguntas de consulta paciente*/
document.addEventListener('DOMContentLoaded', () => {
    const containerSlider = document.querySelector(".container-slider");
    const sliderPerguntas = document.querySelector(".slider-perguntas");
    const btnVoltar = document.querySelector(".container-slider .controles-slider #voltar-slider");
    const btnAvancar = document.querySelector(".container-slider .controles-slider #avancar-slider");
    const perguntas = document.querySelectorAll(".slider-perguntas .pergunta");
    const controles_slider = document.querySelector(".container-slider .controles-slider")

    if (containerSlider){
        let perguntaAtual = 0;
        const qntPerguntas = perguntas.length;


        if (perguntaAtual == 0){
            btnVoltar.style.display = "none"
            controles_slider.style.justifyContent = "flex-end"
        }

        
        function transicaoPergunta() {

            let movimento = perguntaAtual * -100;
            sliderPerguntas.style.transform = `translateX(${movimento}%)`;  
        }

        btnAvancar.addEventListener("click", () =>{ 
                if ((perguntaAtual + 1) < qntPerguntas){
                    if (validarPergunta(perguntaAtual)== false) return /* Validando se a pergunta tÃ¡ preenchida corretamente*/
                    perguntaAtual += 1;
                    btnVoltar.style.display = "block"
                    controles_slider.style.justifyContent = "space-between"
                    transicaoPergunta()
                }

        if ((perguntaAtual + 1) >= qntPerguntas){
            btnAvancar.style.display = "none"

            function resumoConsulta(){
                if (document.querySelector('#pergunta-resumo button')){
                    return
                }
                const botaoagendar = document.createElement('button')
                const resumoConsulta = document.querySelector('#pergunta-resumo')
                const nome = resumoConsulta.querySelector('#nome')
                const dataTexto = resumoConsulta.querySelector('#data')
                const horaTexto = resumoConsulta.querySelector('#hora')
                const motivo = resumoConsulta.querySelector('#motivo')

                const data = Object.keys(novaConsulta.data_hora)[0];
                const hora = novaConsulta.data_hora[data][0];

                motivo.textContent = `${novaConsulta.motivo}`
                dataTexto.textContent = data;
                horaTexto.textContent = hora;

                botaoagendar.textContent = 'Confirmar consulta'
                botaoagendar.addEventListener('click', agendarConsulta);
                

                resumoConsulta.appendChild(botaoagendar)
                

                console.log(novaConsulta.data_hora); 
                console.log(novaConsulta.id_nutricionista);

            }
            
            resumoConsulta()
        }
        console.log (`quantidade pergunta ${qntPerguntas}`)
        console.log(`Proxima ${perguntaAtual + 1}`)
        console.log(`Pergunta Atual ${perguntaAtual}`)
        })

        btnVoltar.addEventListener("click", () =>{
            if ((perguntaAtual - 1) >= 0){
                perguntaAtual -= 1;
                btnAvancar.style.display = "block"
            }
            if ((perguntaAtual - 1) < 0 ){
                btnVoltar.style.display = "none"
                controles_slider.style.justifyContent = "flex-end"
            }

            transicaoPergunta();
            console.log(`Pergunta Atual ${perguntaAtual}`)
        })

    function validarPergunta(perguntaAtual) {
            /* ValidaÃ§Ã£o da pergunta de horÃ¡rio*/
            if (perguntaAtual === 0) {
                const horarios = Object.values(novaConsulta.data_hora).flat();
        
                if (horarios.length !== 1) {
                    mensagem_popup("Por favor, selecione uma data e horÃ¡rio vÃ¡lidos", "erro");
                    return false;
                }
                return true;
            }

            /*ValidaÃ§Ã£o da pergunta de nutricionista*/
            if (perguntaAtual === 1) {
                if (!novaConsulta.id_nutricionista) {
                    mensagem_popup("Por favor, selecione um nutricionista.", "erro");
                    return false;
                }
                return true;
            }

            // Pergunta 2: Motivo da consulta
            if (perguntaAtual === 2) {
                const textarea = document.querySelector("#pergunta-motivo textarea");
                if (!textarea || !textarea.value.trim()) {
                    mensagem_popup("Por favor, insira um motivo vÃ¡lido.", "erro");
                    return false;
                } else {
                    novaConsulta.motivo = textarea.value.trim();
                }
                return true;
            }
            return true;
        }

    }
    
});

/*Funcao para pegar datas e horarios disponiveis do nosso backend e listar no calendario */
document.addEventListener('DOMContentLoaded', async () => {
    const perguntaData = document.querySelector('.slider-perguntas #pergunta-data')

    if (perguntaData){

        async function definirPacienteAtual() {
            const resposta = await fetch('/api/usuarioatual', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            
            const dadosUsuario = await resposta.json();
    
            novaConsulta.id_paciente = dadosUsuario.id;

            console.log('ID do paciente definido:', novaConsulta.id_paciente);
        }

        definirPacienteAtual()
        /*Pegando o JSON com os dias e horarios disponiveis na API do flas para definir mes atual, ano atual e os horarios disponÃ­veis*/
        
        let dadosHorarios = {}
        let mesAtual
        let anoAtual

        async function carregarHorarios() { 
            const resposta = await fetch('/api/verhorarios', { 
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const dados = await resposta.json(); 
            dadosHorarios = dados; 

            const datas = Object.keys(dadosHorarios); 
            if (datas.length > 0) {
                const [ano, mes] = datas[0].split('-').map(Number);
                mesAtual = mes;
                anoAtual = ano;
            }

            console.log(dadosHorarios, mesAtual, anoAtual)
        }
        
        await carregarHorarios();

        const diasCalendario = document.querySelectorAll('.dias-calendario .data');
        const nomeMes = document.querySelector('.nome-mes');
        const btnProximoMes = document.querySelector('.mes #avancar');
        const btnMesAnterior = document.querySelector('.mes #voltar');
        const listaHorarios = document.querySelector('.lista-horarios');
        
        
        /* Funcao para marcar os dias disponÃ­veis no calendario e adicionar event listeners neles para chamar a funcao de listar os horarios*/    
        function configurarCalendario(dadosHorarios) {
            const nomeMeses = [
                'Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            nomeMes.textContent = `${nomeMeses[mesAtual - 1]} de ${anoAtual}`

            diasCalendario.forEach(dia => {
                dia.classList.remove('disponivel', 'selecionado');
                
                const diaAtual = String(dia.textContent).padStart(2, '0');
                const mesAtualStr = String(mesAtual).padStart(2, '0');
                const dataString = `${anoAtual}-${mesAtualStr}-${diaAtual}`
                
                if (dadosHorarios[dataString]) {
                    dia.classList.add('disponivel');
                    console.log(dataString)

                    dia.addEventListener('click', (event) => {
                        
                        event.preventDefault()
                        diasCalendario.forEach(dia => dia.classList.remove('selecionado'));
                        dia.classList.add('selecionado');
                        listarhorarios(dataString);

                        novaConsulta.data_hora = {}
                        novaConsulta.data_hora[dataString] = []
                        
                        console.log(novaConsulta)
                        
                    });
                }
            });

            btnProximoMes.onclick = (e) => {
                e.preventDefault();
                const datasDoProximoMes = Object.keys(dadosHorarios).filter(d => {
                    const [ano, mes] = d.split('-').map(Number);
                    return (ano > anoAtual) || (ano === anoAtual && mes > mesAtual);
                });
                if (datasDoProximoMes.length) {
                    const [ano, mes] = datasDoProximoMes[0].split('-').map(Number);
                    anoAtual = ano;
                    mesAtual = mes;
                    configurarCalendario(dadosHorarios);
                }
            };
            
            btnMesAnterior.addEventListener('click', (event) => {
            event.preventDefault();
            const datas = Object.keys(dadosHorarios);
            const prevData = datas.reverse().find(d => Number(d.split('-')[1]) < mesAtual);
            if (prevData) {
                const [ano, mes] = prevData.split('-').map(Number);
                mesAtual = mes;
                anoAtual = ano;
                configurarCalendario(dadosHorarios);
            }
            });
        }
        
        configurarCalendario(dadosHorarios);
    
        /*Funcao para ficar listando os horÃ¡rios disponiveis de acordo com o dia selecionado no front-end*/
        function listarhorarios(dataString) {
            listaHorarios.innerHTML = '';
            
            const horarios = dadosHorarios[dataString];
        
            console.log(`HorÃ¡rios para ${dataString}`)
            if (horarios.length === 0) {
                listaHorarios.textContent = 'Nenhum horÃ¡rio disponÃ­vel neste dia.';
                return;
            }

            horarios.forEach(hora => {
                const label = document.createElement('label');
                label.classList.add('horario-label');

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'horario';
                input.value = hora;

                const span = document.createElement('span');
                span.textContent = hora;

                label.appendChild(input);
                label.appendChild(span);
                listaHorarios.appendChild(label);

                input.addEventListener('click', () => {
                    novaConsulta.data_hora[dataString] = [hora];
                    console.log('novaConsulta atualizada:', novaConsulta);
                    listarmedicos()
                });
            });
        }

        /*Funcao para listar os medicos disponÃ­veis para o dia e hora selecionado*/

        function listarmedicos() {
            console.log('Listando Nutricionistas');

            fetch("/api/verhorarios", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({data_hora: novaConsulta.data_hora})
            })
            .then(response => response.json())
            .then(dados => {
                console.log("Nutricionistas disponiveis:", dados);

                const listaMedicos = document.querySelector('.lista-medicos');
                listaMedicos.innerHTML = '';

                dados.forEach(medico => {
                    const li = document.createElement('li');
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    const iconenutri = document.createElement('div');
                    const descricao = document.createElement('div');
                    const nome = document.createElement('h1');

                    label.classList.add('cartao-medico');

                    iconenutri.classList.add('icone-medico');
                    iconenutri.innerHTML = '<i class="fa-solid fa-user-doctor" style="color: #63E6BE;"></i>';

                    descricao.classList.add('descricao-med');
                    nome.textContent = `${medico.nome} ${medico.sobrenome}`;
                    descricao.appendChild(nome);

                    input.type = 'radio';
                    input.name = 'medico';
                    input.value = medico.id;

                    input.addEventListener('change', () => {
                        if (input.checked) {
                            novaConsulta.id_nutricionista = medico.id;
                            console.log('MÃ©dico selecionado:', medico);
                            console.log('Nova Consulta atÃ© o momento:', novaConsulta)
                            const cartoesnutricionistas = document.querySelectorAll('.lista-medicos label')

                            cartoesnutricionistas.forEach(cartao => cartao.classList.remove('selecionado'));

                            label.classList.add('selecionado')
                        }
                    });

                    label.appendChild(iconenutri);
                    label.appendChild(descricao);
                    label.appendChild(input);

                    li.appendChild(label);
                    listaMedicos.appendChild(li);
                });
            });
        }


        const inputMotivo = document.querySelector('#pergunta-motivo textarea')
                
        
        inputMotivo.addEventListener('input', adicionarMotivo)
        function adicionarMotivo(){
            const motivo = inputMotivo.value
        
            novaConsulta.motivo = motivo

            console.log(novaConsulta)
        }
    } 
});

/*Funcao para enviar a consulta em si  para o backend*/
async function agendarConsulta(event){
    event.preventDefault()
    
    await fetch('/consulta/agendar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(novaConsulta)
    });

    window.location.href = '/consulta/minhasconsultas'
}

/* ============================= */
/* FUNÃ‡Ã•ES DE MINHAS CONSULTAS PARA PACIENTE E NUTRICIONISTA*/
/* ============================= */

/*Funcao para listar consultas do nutricionista e do paciente */
document.addEventListener('DOMContentLoaded', () => {
    const tabelaConsultas = document.getElementById('tabela-consultas')
    
    if (tabelaConsultas){
        const tbody = tabelaConsultas.querySelector('tbody')
        async function listarconsultas(){
         const dados_usuario = await fetch(`/api/usuarioatual`)
         const usuario = await dados_usuario.json()
         const dados_consultas = await fetch(`/api/consulta/minhasconsultas/${usuario.id}`)
         const consultas = await dados_consultas.json()
         console.log("Consultas encontradas:", consultas)

        for (const consulta of consultas) {
            const tr = document.createElement('tr');
            const status = document.createElement('td');
            const data = document.createElement('td');
            const acoes = document.createElement('td');

            if (usuario.tipo === 'paciente') {
                const idNutricionista = consulta.id_nutricionista;
                const resNutri = await fetch(`/api/usuario/${idNutricionista}`);
                const nutricionista = await resNutri.json();

                const nomeNutricionista = document.createElement('td');
                nomeNutricionista.textContent = `${nutricionista.nome} ${nutricionista.sobrenome}`;

                status.textContent = consulta.status.toUpperCase();
                data.textContent = consulta.data_hora;

                const btnVisulizar = document.createElement('button');
                const btnCancelar = document.createElement('button');

                if (consulta.status === 'concluida') {
                    status.classList.add('status-ativo');
                    btnVisulizar.textContent = 'ðŸ‘ï¸';
                    btnVisulizar.classList.add('botao-acao')
                    /*FunÃ§Ã£o para baixar o relatorio PDF da consulta*/
                    btnVisulizar.addEventListener('click', async () => {
                        try {
                            const res = await fetch(`/consulta/baixar_pdf/${consulta.id}`);
                            if (!res.ok) return mensagem_popup('Erro ao baixar PDF.', 'erro');

                            const blob = await res.blob();
                            const url = URL.createObjectURL(blob);
                            const a = Object.assign(document.createElement('a'), {
                                href: url,
                                download: `relatorio_consulta_${consulta.id}.pdf`
                            });
                            a.click();
                            URL.revokeObjectURL(url);
                        } catch {
                            mensagem_popup('Erro ao baixar PDF.', 'erro');
                        }
                    });
                    acoes.appendChild(btnVisulizar);
                    acoes.appendChild(btnVisulizar);
                }
                if (consulta.status === 'pendente') {
                    status.classList.add('status-inativo');
                    btnCancelar.textContent = 'ðŸš«';
                    acoes.appendChild(btnCancelar);
                }

                tr.appendChild(nomeNutricionista);
                tr.appendChild(status);
                tr.appendChild(data);
                tr.appendChild(acoes);
                tbody.appendChild(tr);
            } else if (usuario.tipo === 'nutricionista') {
                const idPaciente = consulta.id_paciente;
                const resPaciente = await fetch(`/api/usuario/${idPaciente}`);
                const paciente = await resPaciente.json();

                const nomePaciente = document.createElement('td');
                nomePaciente.textContent = `${paciente.nome} ${paciente.sobrenome}`;

                status.textContent = consulta.status.toUpperCase();
                data.textContent = consulta.data_hora;

                const btnVisulizar = document.createElement('button');  
                const btnCancelar = document.createElement('button');   
                const btnAtender = document.createElement('button')

                if (consulta.status === 'concluida') {
                    status.classList.add('status-ativo');
                    btnVisulizar.classList.add('botao-acao')
                    btnVisulizar.textContent = 'ðŸ‘ï¸';
                    acoes.appendChild(btnVisulizar);

                    btnVisulizar.addEventListener('click', async () => {
                        try {
                            const res = await fetch(`/consulta/baixar_pdf/${consulta.id}`);
                            if (!res.ok) return mensagem_popup('Erro ao baixar PDF.', 'erro');

                            const blob = await res.blob();
                            const url = URL.createObjectURL(blob);
                            const a = Object.assign(document.createElement('a'), {
                                href: url,
                                download: `relatorio_consulta_${consulta.id}.pdf`
                            });
                            a.click();
                            URL.revokeObjectURL(url);
                        } catch {
                            mensagem_popup('Erro ao baixar PDF.', 'erro');
                        }
                    });
                }
                if (consulta.status === 'pendente') {
                    status.classList.add('status-inativo');
                    btnAtender.classList.add('botao-acao')
                    btnCancelar.classList.add('botao-acao')
                    
                    btnCancelar.textContent = 'ðŸš«';
                    btnAtender.textContent = 'ðŸ“'

                    btnAtender.addEventListener('click', () => {
                        atenderConsulta(consulta.id);
                    });
                   
                    acoes.appendChild(btnCancelar)
                    acoes.appendChild(btnAtender)
                }

                tr.appendChild(nomePaciente);
                tr.appendChild(status);
                tr.appendChild(data);
                tr.appendChild(acoes);
                tbody.appendChild(tr);
            }
        }

        }

        function atenderConsulta(id){
            window.location.href = window.location.href = `/consulta/atender/${id}`
        }

        listarconsultas()    
    }

});

document.addEventListener('DOMContentLoaded', () => {
    const detalheconsulta = document.querySelector('.container-detalhe-consulta')
    if (detalheconsulta){
        carregarDetalhes();
    }
})

/*Funcao para carregar os detalhes da consulta sÃ³ pro nutricionista*/
async function carregarDetalhes() {
    const id_consulta = window.location.pathname.split('/').pop();

    const dadosNutricionista = await fetch(`/api/usuarioatual`)
    const nutricionista = await dadosNutricionista.json()

    const id_nutricionista = nutricionista.id

    const dadosConsultas = await fetch(`/api/consulta/minhasconsultas/${id_nutricionista}`);
    const consultas = await dadosConsultas.json()

    const consulta = consultas.find(c => c.id === Number(id_consulta))

    const dadosPaciente = await fetch(`/api/usuario/${consulta.id_paciente}`)
    const paciente = await dadosPaciente.json()
    
    const motivo = document.querySelector('#motivo')
    const data_hora = document.querySelector ('#data-hora')

    const nome = document.querySelector('#nome')
    const sobrenome = document.querySelector('#sobrenome')
    const genero = document.querySelector('#genero')
    const idade = document.querySelector('#idade')
    const peso = document.querySelector('#peso')
    const altura = document.querySelector('#altura')
    const doenca_cronica = document.querySelector('#doenca-cronica')

    data_hora.textContent = consulta.data_hora
    motivo.textContent = consulta.motivo
    
    sobrenome.textContent = paciente.sobrenome[0].toUpperCase() + paciente.sobrenome.slice(1)
    nome.textContent = paciente.nome[0].toUpperCase() + paciente.nome.slice(1)
    idade.textContent = paciente.idade
    peso.textContent = `${paciente.peso} Kg`
    altura.textContent = `${paciente.altura}M`
    doenca_cronica.textContent = paciente.doenca_cronica[0].toUpperCase() + paciente.doenca_cronica.slice(1);


    genero.textContent = paciente.genero[0].toUpperCase() + paciente.genero.slice(1);

    const btngroup = document.querySelector('.acoes-consulta .btn-group')
    const btnConcluir = document.createElement('button')
    
    btnConcluir.textContent = 'Concluir Consulta'
    btnConcluir.addEventListener('click', () => concluirConsulta(consulta.id));
    btngroup.appendChild(btnConcluir)

    console.log(paciente)
    console.log(consulta)
    
}

/*Funcao para concluir a consulta*/

function selecionarPDF() {
    return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf'; 
        input.onchange = () => {
            const file = input.files[0];

            if (!file) {
                mensagem_popup('Nenhum arquivo selecionado.', 'erro');
                resolve(null);
                return;
            }

            if (file.type !== 'application/pdf') {
                mensagem_popup('O arquivo precisa ser um PDF.', 'erro');
                resolve(null);
                return;
            }

            resolve(file); 
        };
        input.click();
    });
}

async function concluirConsulta(id) {
    try {
        const pdf = await selecionarPDF();
        if (!pdf) return;

        const formData = new FormData();
        formData.append('pdf', pdf);

        const uploadResponse = await fetch(`/consulta/adicionar_pdf/${id}`, {
            method: 'POST',
            body: formData
        });
        const uploadData = await uploadResponse.json();

        if (uploadData.erro) {
            mensagem_popup('Erro ao enviar o PDF', 'erro');
            return;
        }

        const statusResponse = await fetch(`/consulta/atender/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'concluida' })
        });
        const statusData = await statusResponse.json();

        if (statusData.erro) {
            mensagem_popup(statusData.erro, 'erro');
        } else {
            mensagem_popup('Consulta concluÃ­da com sucesso!', 'sucesso');
        }

    } catch (error) {
        console.error(error);
        mensagem_popup('Erro ao concluir consulta', 'erro');
    }
}

/* FunÃ§Ã£o para carregar informaÃ§Ãµes na pÃ¡gina sobre-usuario e alterar dados*/
document.addEventListener('DOMContentLoaded', function () {
    if (document.title.includes("Sobre o UsuÃ¡rio")) {
        carregardadosUsuario()
    }
});

function carregardadosUsuario(){
    
    fetch('/api/usuarioatual')
        .then(response => response.json())
        .then(usuario => {
            console.log(usuario)
            
            const nomeHeader = document.getElementById('nome-usuario')
            const tipoHeader = document.getElementById('tipo-usuario')
            const emailHeader = document.getElementById('email-usuario')


            const inputNome = document.getElementById('nome');

            const inputSobrenome = document.getElementById('sobrenome');
            
            const inputNascimento = document.getElementById('data_nascimento')

            const inputIdade = document.getElementById('idade')

            const inputPeso = document.getElementById('peso');

            const inputAltura = document.getElementById('altura')

            const inputDoenca = document.getElementById('doenca_cronica')

            const inputTelefone = document.getElementById('telefone')

            const inputGenero = document.getElementById('genero')

            const inputEmail = document.getElementById('email')
            
            inputNome.value = usuario.nome
            inputSobrenome.value = usuario.sobrenome
            inputNascimento.value = usuario.data_nascimento
            inputIdade.value = usuario.idade
            inputAltura.value = usuario.altura
            inputPeso.value = usuario.peso
            inputDoenca.value = usuario.doenca_cronica
            inputTelefone.value = usuario.telefone
            inputGenero.value = usuario.genero

            inputEmail.value = usuario.email

            nomeHeader.textContent = `${usuario.nome} ${usuario.sobrenome}`
            tipoHeader.textContent = usuario.tipo
            emailHeader.textContent = usuario.email
        })
        .catch(erro => mensagem_popup('Erro ao buscar as informaÃ§Ãµes', 'erro'));

    
    const formDadosPessoais = document.querySelector('.formulario-perfil');
    if (formDadosPessoais) {
        formDadosPessoais.addEventListener('submit', function (event) {
            event.preventDefault(); 
            const dadosForm= new FormData(formDadosPessoais);
            const dados = Object.fromEntries(dadosForm.entries());

            console.log("Dados enviados:", dados);
            
            fetch('/sobremim', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(resultado => {
                mensagem_popup('Suas informaÃ§Ãµes foram atualizadas', 'alerta')
            })
            .catch(erro => {
                console.error('Erro ao atualizar:', erro);
                mensagem_popup('Ocorreu um erro ao atualizar suas informaÃ§Ãµes!', 'erro')
            });
        });
    }

    const formSeguranca = document.querySelector('.formulario-seguranca')
    if(formSeguranca){
        formSeguranca.addEventListener('submit', function (event) {
            event.preventDefault(); 
            const dadosForm= new FormData(formSeguranca);
            const dados = Object.fromEntries(dadosForm.entries());

            console.log("Dados enviados:", dados);
            
            fetch('/sobremim', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            })
            .then(response => response.json())
            .then(resultado => {
                mensagem_popup('Suas informaÃ§Ãµes foram atualizadas', 'alerta')
            })
            .catch(erro => {
                console.error('Erro ao atualizar:', erro);
                mensagem_popup('Ocorreu um erro ao atualizar suas informaÃ§Ãµes!', 'erro')
            });
        });
    }
}

/* FUNÃ‡ÃƒO PARA MUDAR ABA NO PERFIL DO USUÃRIO */
function mudarAba(abaId) {
    
    const todasAbas = document.querySelectorAll('.aba');
    todasAbas.forEach(aba => {
        aba.classList.remove('ativa');
    });

    const todosConteudos = document.querySelectorAll('.aba-conteudo');
    todosConteudos.forEach(conteudo => {
        conteudo.classList.remove('ativa');
    });

    const abaClicada = document.querySelector(`.aba[onclick="mudarAba('${abaId}')"]`);
    if (abaClicada) {
        abaClicada.classList.add('ativa');
    }

    const conteudoAba = document.getElementById(`aba-${abaId}`);
    if (conteudoAba) {
        conteudoAba.classList.add('ativa');
    }
    carregardadosUsuario()
}

/* FUNÃ‡ÃƒO PARA CONFIGURAR ABAS DINAMICAMENTE */
function configurarAbasPerfil() {
    const tipoUsuario = obterTipoUsuario();
    const abasContainer = document.querySelector('.abas-perfil');
    
    if (!abasContainer) return;
    
    const abasPermitidas = {
        'paciente': [
            { id: 'dados', texto: 'Dados Pessoais' },
            { id: 'seguranca', texto: 'SeguranÃ§a' }
        ],
        'nutricionista': [
            { id: 'dados', texto: 'Dados Pessoais' },
            { id: 'profissional', texto: 'InformaÃ§Ãµes Profissionais' },
            { id: 'seguranca', texto: 'SeguranÃ§a' }
        ],
        'admin': [
            { id: 'dados', texto: 'Dados Pessoais' },
            { id: 'profissional', texto: 'InformaÃ§Ãµes Profissionais' },
            { id: 'seguranca', texto: 'SeguranÃ§a' },
            { id: 'admin', texto: 'AdministraÃ§Ã£o' }
        ]
    };
    
    abasContainer.innerHTML = '';
    
    const abasDoUsuario = abasPermitidas[tipoUsuario] || abasPermitidas['paciente'];
    
    abasDoUsuario.forEach((aba, index) => {
        const botaoAba = document.createElement('button');
        botaoAba.className = `aba ${index === 0 ? 'ativa' : ''}`;
        botaoAba.setAttribute('onclick', `mudarAba('${aba.id}')`);
        botaoAba.textContent = aba.texto;
        abasContainer.appendChild(botaoAba);
    });
    
    const todosConteudos = document.querySelectorAll('.aba-conteudo');
    todosConteudos.forEach(conteudo => {
        conteudo.classList.remove('ativa');
    });
    
    const primeiroConteudo = document.getElementById(`aba-${abasDoUsuario[0].id}`);
    if (primeiroConteudo) {
        primeiroConteudo.classList.add('ativa');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.container-perfil-usuario')) {
        configurarAbasPerfil();
    }
});

/* FUNÃ‡ÃƒO PARA OBTER O TIPO DE USUÃRIO */
function obterTipoUsuario() {
    if (typeof usuarioTipo !== 'undefined') {
        return usuarioTipo;
    }
    
    const tipoElement = document.getElementById('tipo-usuario-atual');
    if (tipoElement) {
        return tipoElement.value;
    }
    
    const tipoTexto = document.querySelector('.tipo-usuario');
    if (tipoTexto) {
        const texto = tipoTexto.textContent.toLowerCase();
        if (texto.includes('paciente')) return 'paciente';
        if (texto.includes('nutricionista')) return 'nutricionista';
        if (texto.includes('admin')) return 'admin';
    }
    
    return 'paciente'; 
}


/* FUNÃ‡Ã•ES DO GERENCIAR USUÃRIOS */
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('tabela-usuarios')) {
        carregarUsuarios();
        configurarFiltros();
        configurarPesquisa();
    }
});

async function carregarUsuarios() {
    try {
        const resposta = await fetch('/api/gerenciarusuarios');
        const usuarios = await resposta.json();
        
        preenchertabelaUsuarios(usuarios);
    } catch (erro) {
        console.error('Erro ao carregar usuÃ¡rios:', erro);
        mensagem_popup('Erro ao carregar lista de usuÃ¡rios!', 'erro');
    }
}

/* FunÃ§Ã£o para preencher a tabela com usuarios*/
function preenchertabelaUsuarios(usuarios) {
    configurarFiltros(tabela = 'usuarios')

    const tbody = document.querySelector('#corpo-tabela-usuarios');
    const cardsContainer = document.querySelector('#lista-usuarios-cards');

    tbody.innerHTML = ''
    usuarios.forEach(usuario => {
        const linha = document.createElement('tr');
        
        const nome = document.createElement('td')

        const email = document.createElement('td')
        
        const tipo = document.createElement('td')

        const status = document.createElement('td')

        const id = document.createElement('td')

        const acoes = document.createElement('td')

        const btn_excluir = document.createElement('button')

        

        nome.textContent = usuario.nome
        email.textContent = usuario.email

        id.textContent = usuario.id
        
        status.textContent = 'Ativo'
        status.classList.add('status-ativo')

        btn_excluir.textContent = 'Banir ðŸš«'
        btn_excluir.classList.add('botao-acao')
        btn_excluir.classList.add('botao-excluir')
        btn_excluir.addEventListener('click', () => excluirUsuario(usuario.id, usuario.nome));

        acoes.appendChild(btn_excluir)

        let badgeTipo = document.createElement('span');

        if (usuario.tipo == 'nutricionista'){
            badgeTipo.textContent = 'Nutricionista'
            badgeTipo.classList.add('badge-tipo')
             badgeTipo.classList.add('badge-nutricionista')
            tipo.appendChild(badgeTipo)
        } else if (usuario.tipo == 'paciente'){
            badgeTipo.textContent = 'Paciente'
            badgeTipo.classList.add('badge-tipo')
             badgeTipo.classList.add('badge-paciente')
            tipo.appendChild(badgeTipo)
        } else if (usuario.tipo == 'admin'){
            badgeTipo.textContent = 'Administrador'
            badgeTipo.classList.add('badge-tipo')
             badgeTipo.classList.add('badge-admin')
            tipo.appendChild(badgeTipo)
        } 

        linha.appendChild(nome)
        linha.appendChild(id)
        linha.appendChild(email)
        linha.appendChild(tipo)
        linha.appendChild(status)
        linha.appendChild(acoes)

        tbody.appendChild(linha);

        
        /*Criando cards para mobile*/
        if (window.innerWidth < 1150) {
            const listaCards = document.getElementById('lista-usuarios-cards');

           
            const card = document.createElement('div');
            const cardHeader = document.createElement('div');
            const cardDetalhes = document.createElement('div');
            const cardAcoes = document.createElement('div');
            
         
            const nomeUsuario = document.createElement('h3');
            const tipoUsuario = document.createElement('div');
            const infosUsuario = document.createElement('div');

         
            nomeUsuario.textContent = usuario.nome;
            tipoUsuario.textContent = usuario.tipo;

         
            infosUsuario.appendChild(nomeUsuario);
            infosUsuario.appendChild(tipoUsuario);
            cardHeader.appendChild(infosUsuario);

            
            const detalheEmail = document.createElement('div');
            const labelEmail = document.createElement('span');
            const email = document.createElement('span');
            
     
            labelEmail.textContent = 'Email';
            email.textContent = usuario.email;

     
            detalheEmail.classList.add('card-detalhe');
            labelEmail.classList.add('card-label');
            email.classList.add('card-valor');
            
          
            detalheEmail.appendChild(labelEmail);
            detalheEmail.appendChild(email);
            cardDetalhes.appendChild(detalheEmail);
        
            const detalheTipo = document.createElement('div');
            const labelTipo = document.createElement('span');
            const valorTipo = document.createElement('span');

     
            labelTipo.textContent = 'Tipo';
            valorTipo.textContent = usuario.tipo;

           
            detalheTipo.classList.add('card-detalhe');
            labelTipo.classList.add('card-label');
       
            valorTipo.classList.add('card-badge', `badge-${usuario.tipo}`); 

            detalheTipo.appendChild(labelTipo);
            detalheTipo.appendChild(valorTipo);
            cardDetalhes.appendChild(detalheTipo);
            
         
            const detalheStatus = document.createElement('div');
            const labelStatus = document.createElement('span');
            const valorStatus = document.createElement('span');

            const statusText = 'Ativo'; 
            valorStatus.textContent = statusText;
            labelStatus.textContent = 'Status';
            
          
            detalheStatus.classList.add('card-detalhe');
            labelStatus.classList.add('card-label');
            valorStatus.classList.add('card-valor', `status-${statusText.toLowerCase()}`); 

          
            detalheStatus.appendChild(labelStatus);
            detalheStatus.appendChild(valorStatus);
            cardDetalhes.appendChild(detalheStatus);
            
           
           
            const botaoExcluir = document.createElement('button');
            
      
            botaoExcluir.textContent = 'ðŸš« Banir';
            
            
            botaoExcluir.classList.add('card-botao', 'excluir');
            
            botaoExcluir.setAttribute('onclick', `excluirUsuario(${usuario.id}, '${usuario.nome}')`);
        
     
            cardAcoes.appendChild(botaoExcluir);
       
            tipoUsuario.classList.add('card-tipo');
            card.classList.add('card-tabela');
            cardHeader.classList.add('card-header');
            cardDetalhes.classList.add('card-detalhes');
            infosUsuario.classList.add('card-info'); 
            cardAcoes.classList.add('card-acoes'); 
            
     
            card.appendChild(cardHeader);
            card.appendChild(cardDetalhes);
            card.appendChild(cardAcoes);
            
        
            listaCards.appendChild(card);
        }
    });

}

function configurarFiltros(tabela) {

    if (tabela== 'usuarios'){
        const containerFiltros = document.querySelector('.filtros-tabela');

        const filtrosExistentes = document.querySelectorAll('.filtro-botao')

        if (filtrosExistentes.length > 0){
            return
        }
        
        const todos = document.createElement('button')
        const pacientes = document.createElement('button')
        const nutricionistas = document.createElement('button')
        const administradores = document.createElement('button')

        todos.classList.add('filtro-botao');
        pacientes.classList.add('filtro-botao');
        nutricionistas.classList.add('filtro-botao');
        administradores.classList.add('filtro-botao');

        
        todos.textContent = 'Todos'
        todos.addEventListener('click', () => filtrarTabela('todos', 'usuarios'));

        pacientes.textContent = 'Pacientes'
        pacientes.addEventListener('click', () => filtrarTabela('paciente', 'usuarios'));

        nutricionistas.textContent = 'Nutricionistas'
        nutricionistas.addEventListener('click', () => filtrarTabela('nutricionista', 'usuarios'));
        
        administradores.textContent = 'Administradores'
        administradores.addEventListener('click', () => filtrarTabela('administrador', 'usuarios'));


        containerFiltros.appendChild(nutricionistas)
        containerFiltros.appendChild(administradores)
        containerFiltros.appendChild(pacientes)
        containerFiltros.appendChild(todos)
        botoesFiltro = document.querySelectorAll('.filtro-botao')
        
        botoesFiltro.forEach(botao => {
            botao.addEventListener('click', function() {
                botoesFiltro.forEach(b => b.classList.remove('ativo'));
                this.classList.add('ativo');
                
            });
        });
    }
    
}

function filtrarTabela(filtro, tabela) {
    if (tabela == 'usuarios'){
        const linhas = document.querySelectorAll('#tabela-usuarios tbody tr');

        linhas.forEach(linha => {
            tipo = linha.querySelector(".badge-tipo").textContent.toLocaleLowerCase()
            
            if (filtro === 'todos') {
                linha.style.display = '';
            } else if (filtro === 'nutricionista' && tipo === 'nutricionista') {
                linha.style.display = '';
            } else if (filtro === 'paciente' && tipo === 'paciente') {
                linha.style.display = '';
            } else if (filtro === 'administrador' && tipo === 'administrador') {
                linha.style.display = '';
            } else {
                linha.style.display = 'none';
            }
        });

        const cards = document.querySelectorAll('.cards-tabela .card-tabela')

        if (cards){
            cards.forEach( card => {
                tipo = card.querySelector(".card-tipo").textContent.toLocaleLowerCase()
                if (filtro === 'todos') {
                card.style.display = '';
                } else if (filtro === 'nutricionista' && tipo === 'nutricionista') {
                    card.style.display = '';
                } else if (filtro === 'paciente' && tipo === 'paciente') {
                    card.style.display = '';
                } else if (filtro === 'administrador' && tipo === 'admin') {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            })
        }
    }
        
}

function configurarPesquisa() {
    const inputPesquisa = document.querySelector('.barra-pesquisa-usuarios input');
    const botaoPesquisa = document.querySelector('.botao-pesquisa');
    
    function pesquisar() {
        const termo = inputPesquisa.value.toLowerCase();
        const linhas = document.querySelectorAll('#tabela-usuarios tbody tr');
        
        linhas.forEach(linha => {
            const textoLinha = linha.textContent.toLowerCase();
            linha.style.display = textoLinha.includes(termo) ? '' : 'none';
        });
    }
    
    inputPesquisa.addEventListener('input', pesquisar);
    botaoPesquisa.addEventListener('click', pesquisar);
}

async function excluirUsuario(id, nome) {
    if (confirm(`Tem certeza que deseja excluir o usuÃ¡rio "${nome}"? Esta aÃ§Ã£o nÃ£o pode ser desfeita.`)) {
        try {
            const resposta = await fetch(`/gerenciarusuarios`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: id })
            });

            const resultado = await resposta.json();
            
            if (resposta.sucesso) {
                mensagem_popup('UsuÃ¡rio ExcluÃ­do com sucesso!', 'confirmacao');
                carregarUsuarios();
            } else {
                mensagem_popup(resultado.erro, 'erro');
            }
        } catch (erro) {
            console.error('Erro ao excluir usuÃ¡rio:', erro);
            mensagem_popup('Erro ao excluir usuÃ¡rio!', 'erro');
        }
    }
}

/* ============================= */
/* FUNCÃ•ES DO SITE EM GERAL*/
/* ============================= */

/*Sistemas do menu mobile*/

/* FunÃ§Ã£o para sempre exibir o menu no pc e ocultar inicialmente no mobile (para evitar bugs entre mudar do mobile para o pc)*/
function transicao_menu() { 
const nav = document.querySelector('.menu_nav')
    if (nav){
        if (window.innerWidth > 1151) {
        nav.style.display = 'block'
        } else{
            nav.style.display = 'none'
        };
    };
    }
    

window.addEventListener("load", transicao_menu);
window.addEventListener("resize", transicao_menu);


/*FunÃ§Ã£o para exibir menu mobile*/
const btn_mobile = document.getElementById("botao-menu-mobile");

if (btn_mobile) {
    document.getElementById("botao-menu-mobile").addEventListener("click",function(){
    const nav = document.querySelector('.menu_nav')

    if (nav.style.display == 'none'){
    nav.style.display = 'block'
    } else{
    nav.style.display = 'none'
    };
    });

}



/*FunÃ§Ã£o de Exibir uma mensagem popup na tela*/
function mensagem_popup(texto, tipo){
    let container_mensagem = document.createElement("div")
    let mensagem = document.createElement("div");
    let imagem = document.createElement("img");
    let h1 = document.createElement("h1");
    let p = document.createElement ("p");

    if (document.querySelector(".container-mensagem-popup")) return;

    if(tipo === 'erro'){
        imagem.src = "/static/imagens/icones animados/erro.gif"
        h1.textContent = "Erro!"

    } else if (tipo === 'alerta'){
        imagem.src = "/static/imagens/icones animados/alerta.gif"
        h1.textContent = "Alerta!"

    } else if (tipo === 'confirmacao'){
        imagem.src = "/static/imagens/icones animados/alerta.gif"
    }; 

    p.textContent = texto

    mensagem.appendChild(imagem);
    mensagem.appendChild(h1);
    mensagem.appendChild(p);
    mensagem.classList.add("mensagem-popup");

    container_mensagem.appendChild(mensagem)
    container_mensagem.classList.add("container-mensagem-popup")

    document.body.appendChild(container_mensagem)  
    
    setTimeout(() => { 
        container_mensagem.remove(); }, 2000
    );

};

/*Sistema de mudar tema*/
const botao_tema = document.getElementById("botao-tema");

if (botao_tema) {
    
    document.getElementById('botao-tema').addEventListener("click", function(){
    let tema_salvo = localStorage.getItem('tema-salvo') || 'claro';
    
    if (tema_salvo === 'escuro'){
        localStorage.setItem('tema-salvo','claro');
        aplicar_tema();

        botao_tema.textContent = "ðŸŒ™";
        botao_tema.style.background = "#160000ce";

        mensagem_popup(`Tema alterado para ${tema_salvo}!`, "alerta");
        
    } else if (tema_salvo === 'claro') {
        localStorage.setItem('tema-salvo','escuro');
        aplicar_tema();

        botao_tema.textContent = "â˜€ï¸";
        botao_tema.style.background = "#03697eff";

        mensagem_popup(`Tema alterado para ${tema_salvo}!`, "alerta");
    };
});
}
/*FunÃ§Ã£o para aplicar o tema*/
function aplicar_tema(){
    let tema_salvo = localStorage.getItem("tema-salvo");

    if (tema_salvo === "escuro") {
        document.body.classList.add("escuro");
    
    } else {
        document.body.classList.remove("escuro");
    }
}

aplicar_tema(); /*Chamando a funÃ§Ã£o sempre que o site carregar*/

/*SISTEMAS DA LOJA (que provavelmente vÃ£o ser removidos)*/

/*FunÃ§Ã£o de pesquisa de produtos*/

const searchbarLoja = document.querySelector('#searchbar-produtos input');

if (searchbarLoja) {
    searchbarLoja.addEventListener("input", pesquisar_produtos);
}

function pesquisar_produtos() {
    let input = document.querySelector('#searchbar-produtos input').value.toLowerCase();
    let produtos = document.querySelectorAll('.cartao_produto');
    let listaProdutos = document.querySelector('.conteudo_pagina_loja');
    let produtoEncontrado = false;
    let mensagemErro = document.querySelector('.container-msg-sem-produto')
    const containerLoja = document.querySelector('.container_pagina_loja');

    produtos.forEach(produto => {
        let nomeProduto = produto.querySelector('.cartao_produto_descricao h1').textContent.toLowerCase();
        let descricaoProduto = produto.querySelector('.cartao_produto_descricao h2').textContent.toLowerCase();
        if(nomeProduto.includes(input) || descricaoProduto.includes(input)) {
            produto.style.display = '';
            produtoEncontrado = true;
            
        } else {
            produto.style.display = 'none';
        }
    });

    if (mensagemErro) {
            mensagemErro.remove();
    };
    if (produtoEncontrado === false) {

        containerMsg = document.createElement('div');
        msg = document.createElement('div');
        icone = document.createElement('div');
        h1 = document.createElement('h1');
        h2 = document.createElement('h2');

        icone.innerHTML = '<i class="fa-solid fa-face-frown-open" style="color: #63E6BE;"></i>';
        icone.classList.add('icone');
        h1.textContent = "Que pena, nÃ£o encontramos nenhum produto com esse nome ou descriÃ§Ã£o.";   
        h2.textContent = "Mas faremos o possÃ­vel para adicionar esse produto em nosso estoque o mais rÃ¡pido possÃ­vel!";
        
        
        containerMsg.classList.add('container-msg-sem-produto');
        msg.classList.add('msg-sem-produto');
        msg.appendChild(icone);
        msg.appendChild(h1);
        msg.appendChild(h2);

        containerMsg.appendChild(msg);
        containerLoja.appendChild(containerMsg);
    };
};