
{% extends 'base.html' %}
{% block tituloPagina %}
    <title>Gerenciar Usu√°rios - P.A.K.I</title>
{% endblock %}
{% block conteudoPagina %}
<div class="container-gerenciar-usuarios">
    <div class="cabecalho-gerenciamento">
        <h1>Gerenciar Usu√°rios</h1>
        <div class="barra-pesquisa-usuarios">
            <input type="text" id="campo-pesquisa" placeholder="Pesquisar usu√°rios..." onkeyup="filtrarUsuarios()">
            <button class="botao-pesquisa" onclick="filtrarUsuarios()">üîç</button>
        </div>
    </div>

    <div class="filtros-usuarios">
        <button class="filtro-botao ativo" onclick="filtrarPorTipo('todos')">Todos</button>
        <button class="filtro-botao" onclick="filtrarPorTipo('nutricionista')">Nutricionistas</button>
        <button class="filtro-botao" onclick="filtrarPorTipo('paciente')">Pacientes</button>
        <button class="filtro-botao" onclick="filtrarPorTipo('admin')">Administradores</button>
    </div>

    <div class="tabela-usuarios">
        <table id="tabela-usuarios">
            <thead>
                <tr>
                    <th>Usu√°rio</th>
                    <th>Email</th>
                    <th>Tipo</th>
                    <th>Telefone</th>
                    <th>Data Cadastro</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="corpo-tabela">
                <!-- Os usu√°rios ser√£o carregados via JavaScript -->
                <tr>
                    <td colspan="6" style="text-align: center;">Carregando usu√°rios...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div id="modal-confirmacao" class="modal-usuario" style="display: none;">
    <div class="modal-conteudo">
        <h3>Confirmar Exclus√£o</h3>
        <p id="mensagem-confirmacao">Tem certeza que deseja excluir este usu√°rio?</p>
        <div class="botoes-modal">
            <button class="botao-acao botao-excluir" onclick="confirmarExclusao()">Sim, Excluir</button>
            <button class="botao-acao botao-visualizar" onclick="fecharModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
let usuarios = [];
let usuarioParaExcluir = null;
let filtroAtual = 'todos';
let termoPesquisa = '';

// Carregar usu√°rios quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarUsuarios();
});

function carregarUsuarios() {
    fetch('/api/usuarios')
        .then(response => response.json())
        .then(data => {
            usuarios = data;
            renderizarUsuarios();
        })
        .catch(error => {
            console.error('Erro ao carregar usu√°rios:', error);
            document.getElementById('corpo-tabela').innerHTML = 
                '<tr><td colspan="6" style="text-align: center; color: red;">Erro ao carregar usu√°rios</td></tr>';
        });
}

function renderizarUsuarios() {
    const corpoTabela = document.getElementById('corpo-tabela');
    
    if (usuarios.length === 0) {
        corpoTabela.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usu√°rio encontrado</td></tr>';
        return;
    }

    let usuariosFiltrados = usuarios.filter(usuario => {
        // Aplicar filtro de tipo
        if (filtroAtual !== 'todos' && usuario.tipo !== filtroAtual) {
            return false;
        }
        
        // Aplicar filtro de pesquisa
        if (termoPesquisa) {
            const termo = termoPesquisa.toLowerCase();
            const nomeCompleto = `${usuario.nome} ${usuario.sobrenome}`.toLowerCase();
            return nomeCompleto.includes(termo) || 
                   usuario.email.toLowerCase().includes(termo) ||
                   usuario.tipo.toLowerCase().includes(termo);
        }
        
        return true;
    });

    if (usuariosFiltrados.length === 0) {
        corpoTabela.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum usu√°rio encontrado com os filtros aplicados</td></tr>';
        return;
    }

    corpoTabela.innerHTML = usuariosFiltrados.map(usuario => `
        <tr>
            <td>
                <div class="usuario-info">
                    <div>
                        <strong>${usuario.nome} ${usuario.sobrenome}</strong>
                        <div>${usuario.tipo === 'nutricionista' ? 'Nutricionista' : 
                              usuario.tipo === 'admin' ? 'Administrador' : 'Paciente'}</div>
                    </div>
                </div>
            </td>
            <td>${usuario.email}</td>
            <td>
                <span class="badge-tipo ${usuario.tipo === 'nutricionista' ? 'badge-medico' : 
                                       usuario.tipo === 'admin' ? 'badge-admin' : 'badge-paciente'}">
                    ${usuario.tipo === 'nutricionista' ? 'Nutricionista' : 
                     usuario.tipo === 'admin' ? 'Admin' : 'Paciente'}
                </span>
            </td>
            <td>${usuario.telefone}</td>
            <td>${usuario.data_cadastro}</td>
            <td>
                <div class="acoes-usuario">
                    <a href="/sobreUsuario?id=${usuario.id}" class="botao-acao botao-visualizar" title="Visualizar">üëÅÔ∏è</a>
                    <button class="botao-acao botao-excluir" title="Excluir" onclick="solicitarExclusao(${usuario.id}, '${usuario.nome} ${usuario.sobrenome}')">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function filtrarPorTipo(tipo) {
    // Atualizar bot√µes de filtro
    document.querySelectorAll('.filtro-botao').forEach(botao => {
        botao.classList.remove('ativo');
    });
    event.target.classList.add('ativo');
    
    filtroAtual = tipo;
    renderizarUsuarios();
}

function filtrarUsuarios() {
    termoPesquisa = document.getElementById('campo-pesquisa').value.toLowerCase();
    renderizarUsuarios();
}

function solicitarExclusao(usuarioId, nomeUsuario) {
    usuarioParaExcluir = usuarioId;
    document.getElementById('mensagem-confirmacao').textContent = 
        `Tem certeza que deseja excluir o usu√°rio "${nomeUsuario}"? Esta a√ß√£o n√£o pode ser desfeita.`;
    document.getElementById('modal-confirmacao').style.display = 'flex';
}

function fecharModal() {
    document.getElementById('modal-confirmacao').style.display = 'none';
    usuarioParaExcluir = null;
}

function confirmarExclusao() {
    if (!usuarioParaExcluir) return;
    
    fetch(`/api/usuarios/${usuarioParaExcluir}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            alert('Usu√°rio exclu√≠do com sucesso!');
            carregarUsuarios(); // Recarregar a lista
        } else {
            alert('Erro ao excluir usu√°rio: ' + data.erro);
        }
        fecharModal();
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao excluir usu√°rio');
        fecharModal();
    });
}

// Fechar modal ao clicar fora
document.getElementById('modal-confirmacao').addEventListener('click', function(e) {
    if (e.target === this) {
        fecharModal();
    }
});
</script>

<style>
.botoes-modal {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

.botoes-modal button {
    padding: 10px 20px;
}

.modal-conteudo {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
}

/* Estilos para os badges */
.badge-medico {
    background: #007bff;
    color: white;
}

.badge-paciente {
    background: #28a745;
    color: white;
}

.badge-admin {
    background: #dc3545;
    color: white;
}

.badge-tipo {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}
</style>
{% endblock %}
